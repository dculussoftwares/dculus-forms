# MongoDB Atlas Terraform Module

This module provisions MongoDB Atlas infrastructure for the Dculus Forms application across multiple environments (dev, staging, production).

## Architecture

- **Provider**: AWS
- **Region**: ap-south-1 (Mumbai, India)
- **Cluster Tier**: M0 (Free Tier)
  - 512MB storage
  - Shared RAM and CPU
  - No backups (M0 limitation)
- **MongoDB Version**: 8.0
- **Cluster Type**: REPLICASET
- **Network Access**: 0.0.0.0/0 (required for Azure Container Apps)

## Project Structure

```
mongodb/
├── main.tf                    # MongoDB Atlas provider and project
├── cluster.tf                 # M0 cluster configuration
├── database-user.tf           # Database user with readWrite role
├── network-access.tf          # IP whitelist (0.0.0.0/0)
├── variables.tf               # Variable definitions
├── outputs.tf                 # Connection string outputs
├── .gitignore                 # Git ignore rules
├── README.md                  # This file
└── environments/
    ├── dev/
    │   ├── terraform.tfvars   # Dev environment configuration
    │   └── backend.tf         # Terraform state backend
    ├── staging/
    │   ├── terraform.tfvars   # Staging environment configuration
    │   └── backend.tf         # Terraform state backend
    └── production/
        ├── terraform.tfvars   # Production environment configuration
        └── backend.tf         # Terraform state backend
```

## Deployment Method

**⚠️ IMPORTANT**: This infrastructure is **ONLY** deployed via GitHub Actions workflow.

Manual local deployment is **NOT** supported or recommended for security reasons.

## GitHub Actions Workflow

The MongoDB Atlas infrastructure is deployed as part of the multi-cloud deployment workflow:

**Workflow File**: `.github/workflows/multi-cloud-deployment.yml`

**Deployment Steps**:
1. MongoDB Atlas project and cluster provisioning
2. Database user creation
3. Network access configuration
4. Connection string generation and storage

## Required GitHub Secrets

### Repository Secrets (Settings → Secrets and variables → Actions → Repository secrets)

```
MONGODB_ATLAS_PUBLIC_KEY     = kobtbgvv
MONGODB_ATLAS_PRIVATE_KEY    = 5c4e95f4-94e8-4a27-90d9-4040cdc255e1
MONGODB_ATLAS_ORG_ID         = <your-organization-id>
```

### Environment Secrets (Settings → Environments → [dev/staging/production] → Environment secrets)

**For Development environment**:
```
MONGODB_DATABASE_PASSWORD = <generate-random-32-character-string>
```

**For Staging environment**:
```
MONGODB_DATABASE_PASSWORD = <generate-random-32-character-string>
```

**For Production environment**:
```
MONGODB_DATABASE_PASSWORD = <generate-random-32-character-string>
```

## How to Deploy

### Via GitHub Actions (Recommended)

1. **Set up GitHub Secrets** (one-time setup):
   - Add repository secrets for MongoDB Atlas API credentials
   - Add environment secrets for database passwords in each environment

2. **Trigger Workflow**:
   - Go to **Actions** → **Multi-Cloud Deployment**
   - Click **Run workflow**
   - Select environment (dev/staging/production)
   - Ensure **"Deploy MongoDB Atlas infrastructure"** is checked
   - Click **Run workflow**

3. **Monitor Deployment**:
   - Watch the workflow execution in GitHub Actions
   - MongoDB deployment runs in parallel with Cloudflare R2
   - Connection string is automatically saved to environment secrets

4. **Verify Deployment**:
   - Check workflow summary for MongoDB deployment status
   - Verify cluster is created in MongoDB Atlas dashboard
   - Confirm connection string is saved in GitHub environment secrets

## Environment Configuration

Each environment has its own:
- MongoDB Atlas project
- M0 cluster (AWS Mumbai)
- Database user with unique password
- Network access rules
- Terraform state (stored in Azure Blob Storage)

### Environment Details

| Environment | Project Name | Cluster Name | Database User |
|-------------|--------------|--------------|---------------|
| Dev | `dculus-forms-dev` | `dculus-forms-dev-mongodb` | `dculus_app_user_dev` |
| Staging | `dculus-forms-staging` | `dculus-forms-staging-mongodb` | `dculus_app_user_staging` |
| Production | `dculus-forms-production` | `dculus-forms-production-mongodb` | `dculus_app_user_production` |

## Outputs

The module provides the following outputs (automatically used by Azure Container Apps deployment):

- **mongodb_connection_string**: Full connection string for application use (sensitive)
- **project_id**: MongoDB Atlas project ID
- **project_name**: MongoDB Atlas project name
- **cluster_id**: MongoDB Atlas cluster ID
- **cluster_name**: MongoDB Atlas cluster name
- **cluster_state**: Cluster state (e.g., "IDLE", "CREATING")
- **database_username**: Database username

## Connection String

The connection string is automatically:
1. Generated by Terraform during deployment
2. Saved to GitHub environment secrets as `MONGODB_CONNECTION_STRING`
3. Used by Azure Container Apps deployment job
4. Injected into backend containers as `DATABASE_URL` environment variable

**Format**:
```
mongodb+srv://<username>:<password>@<cluster-host>/?retryWrites=true&w=majority
```

## Terraform State

Terraform state is stored in Azure Blob Storage:

- **Resource Group**: `dculus-global-terraform-assets-resource-grp`
- **Storage Account**: `dculusterraformstates`
- **Container**: `dculus-forms-mongodb-{env}-state`
- **Key**: `terraform.tfstate`

## Security

✅ **Public Repo Safe**:
- All sensitive values via GitHub secrets
- No credentials in code
- Connection strings marked sensitive
- Masked in GitHub Actions logs

✅ **Network Security**:
- IP whitelist: 0.0.0.0/0 (required for Azure Container Apps)
- Database authentication required
- TLS/SSL enforced by default

✅ **Access Control**:
- Separate projects per environment
- Dedicated database users per environment
- readWrite role only (not admin)

## M0 Free Tier Limitations

⚠️ **Important Limitations**:
- 512MB storage maximum
- No automated backups
- No point-in-time recovery
- Shared RAM and CPU
- No VPC peering
- No private endpoints
- Limited to 1 free cluster per Atlas project

## Troubleshooting

### Workflow Fails During MongoDB Plan/Apply

**Check**:
1. GitHub secrets are correctly set (repository and environment level)
2. MongoDB Atlas API keys are valid
3. Organization ID is correct
4. Terraform state container exists in Azure

### Connection String Not Saved

**Check**:
1. `terraform-mongodb-apply` job completed successfully
2. GitHub environment secrets have write permissions
3. Environment name matches (dev/staging/production)

### Azure Container Apps Can't Connect

**Check**:
1. Connection string is saved in correct GitHub environment
2. Network access allows 0.0.0.0/0
3. Database user credentials are correct
4. Cluster is in "IDLE" state (not "CREATING")

## Support

For issues or questions:
1. Check GitHub Actions workflow logs
2. Verify MongoDB Atlas dashboard for cluster status
3. Review this README for configuration details
4. Contact DevOps team

## Related Documentation

- [Multi-Cloud Deployment Guide](../MULTI_CLOUD_DEPLOYMENT_GUIDE.md)
- [Quick Start Guide](../QUICK_START.md)
- [MongoDB Atlas Terraform Provider](https://registry.terraform.io/providers/mongodb/mongodbatlas/latest/docs)
