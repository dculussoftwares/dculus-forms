name: Multi-Cloud Infrastructure Destroy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      destroy_mongodb:
        description: 'ðŸ”¥ Destroy MongoDB Atlas (PERMANENT DATA LOSS - Cannot be recovered)'
        required: false
        type: boolean
        default: false
      destroy_postgres:
        description: 'ðŸ”¥ Destroy Azure PostgreSQL (PERMANENT DATA LOSS - Cannot be recovered)'
        required: false
        type: boolean
        default: false
      destroy_neon:
        description: 'ðŸ”¥ Destroy NeonDB Postgres (PERMANENT DATA LOSS - Cannot be recovered)'
        required: false
        type: boolean
        default: false
      destroy_cloudflare_pages:
        description: 'Destroy Cloudflare Pages (form-app, admin-app, viewer-app - Static sites)'
        required: false
        type: boolean
        default: false
      destroy_cloudflare_r2:
        description: 'ðŸ”¥ Destroy Cloudflare R2 & CDN (ALL FILES DELETED - Cannot be recovered)'
        required: false
        type: boolean
        default: false
      destroy_azure:
        description: 'Destroy Azure Container Apps (Stateless - Safe to recreate)'
        required: false
        type: boolean
        default: false
      confirmation:
        description: 'Type "DESTROY-{environment}" to confirm (e.g., "DESTROY-dev")'
        required: true
        type: string

permissions:
  id-token: write      # Required for OIDC authentication with Azure
  contents: read       # Required for checking out code

env:
  TERRAFORM_VERSION: '1.6.0'
  MONGODB_TERRAFORM_DIR: 'dculus-forms/infrastructure/multi-cloud/terraform/mongodb'
  POSTGRES_TERRAFORM_DIR: 'dculus-forms/infrastructure/multi-cloud/terraform/azure-postgres'
  CLOUDFLARE_TERRAFORM_DIR: 'dculus-forms/infrastructure/multi-cloud/terraform/cloudflare'
  CLOUDFLARE_SERVICE_TERRAFORM_DIR: 'dculus-forms/infrastructure/multi-cloud/terraform/cloudflare-service-domain'
  CLOUDFLARE_PAGES_TERRAFORM_DIR: 'dculus-forms/infrastructure/multi-cloud/terraform/cloudflare-pages'
  CLOUDFLARE_PAGES_ADMIN_TERRAFORM_DIR: 'dculus-forms/infrastructure/multi-cloud/terraform/cloudflare-pages-admin'
  CLOUDFLARE_PAGES_VIEWER_TERRAFORM_DIR: 'dculus-forms/infrastructure/multi-cloud/terraform/cloudflare-pages-viewer'
  AZURE_TERRAFORM_DIR: 'dculus-forms/infrastructure/multi-cloud/terraform/azure'

jobs:
  # Validate destroy request and confirmation
  validate-destroy-request:
    name: Validate Destroy Request
    runs-on: ubuntu-latest
    outputs:
      confirmed: ${{ steps.validate.outputs.confirmed }}
      environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Validate Confirmation
        id: validate
        run: |
          EXPECTED="DESTROY-${{ github.event.inputs.environment }}"
          ACTUAL="${{ github.event.inputs.confirmation }}"

          echo "Expected confirmation: $EXPECTED"
          echo "Actual confirmation: $ACTUAL"

          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "âŒ ERROR: Confirmation does not match!"
            echo "Expected: $EXPECTED"
            echo "Got: $ACTUAL"
            exit 1
          fi

          echo "âœ… Confirmation verified: $ACTUAL"
          echo "confirmed=true" >> $GITHUB_OUTPUT

      - name: Verify At Least One Provider Selected
        run: |
          if [ "${{ github.event.inputs.destroy_mongodb }}" != "true" ] && \
             [ "${{ github.event.inputs.destroy_postgres }}" != "true" ] && \
             [ "${{ github.event.inputs.destroy_neon }}" != "true" ] && \
             [ "${{ github.event.inputs.destroy_cloudflare_pages }}" != "true" ] && \
             [ "${{ github.event.inputs.destroy_cloudflare_r2 }}" != "true" ] && \
             [ "${{ github.event.inputs.destroy_azure }}" != "true" ]; then
            echo "âŒ ERROR: No providers selected for destruction!"
            echo "Please select at least one provider to destroy."
            exit 1
          fi

          echo "âœ… At least one provider selected for destruction"

      - name: Display Destruction Plan
        run: |
          echo "ðŸ”¥ DESTRUCTION PLAN ðŸ”¥"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Triggered by: @${{ github.actor }}"
          echo ""
          echo "Resources to be destroyed:"

          if [ "${{ github.event.inputs.destroy_azure }}" = "true" ]; then
            echo "  âœ… Azure Container Apps (Stateless)"
          else
            echo "  â­ï¸ Azure Container Apps (Skipped)"
          fi

          if [ "${{ github.event.inputs.destroy_cloudflare_pages }}" = "true" ]; then
            echo "  âœ… Cloudflare Pages (form-app, admin-app, viewer-app)"
          else
            echo "  â­ï¸ Cloudflare Pages (Skipped)"
          fi

          if [ "${{ github.event.inputs.destroy_cloudflare_r2 }}" = "true" ]; then
            echo "  ðŸ”¥ Cloudflare R2 Buckets & CDN (ALL FILES DELETED)"
          else
            echo "  â­ï¸ Cloudflare R2 & CDN (Skipped)"
          fi

          if [ "${{ github.event.inputs.destroy_mongodb }}" = "true" ]; then
            echo "  âš ï¸âš ï¸âš ï¸ MongoDB Atlas (PERMANENT DATA LOSS)"
          else
            echo "  â­ï¸ MongoDB Atlas (Skipped)"
          fi

          if [ "${{ github.event.inputs.destroy_postgres }}" = "true" ]; then
            echo "  âš ï¸âš ï¸âš ï¸ Azure PostgreSQL (PERMANENT DATA LOSS)"
          else
            echo "  â­ï¸ Azure PostgreSQL (Skipped)"
          fi

          if [ "${{ github.event.inputs.destroy_neon }}" = "true" ]; then
            echo "  âš ï¸âš ï¸âš ï¸ NeonDB Postgres (PERMANENT DATA LOSS)"
          else
            echo "  â­ï¸ NeonDB Postgres (Skipped)"
          fi

          echo ""
          echo "âš ï¸ WARNING: This action cannot be undone!"

  # Setup Azure Terraform Backend
  setup-azure-backend:
    name: Setup Azure Terraform Backend
    runs-on: ubuntu-latest
    needs: validate-destroy-request
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Azure Storage containers for Terraform state
        run: |
          ENV="${{ github.event.inputs.environment }}"
          RESOURCE_GROUP="dculus-global-terraform-assets-resource-grp"
          STORAGE_ACCOUNT="dculusterraformstates"
          LOCATION="centralindia"

          echo "ðŸ“¦ Setting up Terraform backend for environment: $ENV"

          # Create resource group if it doesn't exist
          if ! az group show --name "$RESOURCE_GROUP" &>/dev/null; then
            echo "ðŸ“¦ Creating resource group: $RESOURCE_GROUP in $LOCATION"
            az group create \
              --name "$RESOURCE_GROUP" \
              --location "$LOCATION"
            echo "âœ… Resource group created: $RESOURCE_GROUP"
          else
            echo "âœ… Resource group exists: $RESOURCE_GROUP"
          fi

          # Create storage account if it doesn't exist
          if ! az storage account show \
            --name "$STORAGE_ACCOUNT" \
            --resource-group "$RESOURCE_GROUP" &>/dev/null; then
            echo "ðŸ“¦ Creating storage account: $STORAGE_ACCOUNT in $LOCATION"
            az storage account create \
              --name "$STORAGE_ACCOUNT" \
              --resource-group "$RESOURCE_GROUP" \
              --location "$LOCATION" \
              --sku Standard_LRS \
              --kind StorageV2 \
              --allow-blob-public-access false \
              --min-tls-version TLS1_2
            echo "âœ… Storage account created: $STORAGE_ACCOUNT"
          else
            echo "âœ… Storage account exists: $STORAGE_ACCOUNT"
          fi

          # Create Cloudflare R2 container
          CLOUDFLARE_CONTAINER="dculus-forms-cloudflare-r2-${ENV}-state"
          if ! az storage container show \
            --name "$CLOUDFLARE_CONTAINER" \
            --account-name "$STORAGE_ACCOUNT" &>/dev/null; then
            echo "ðŸ“¦ Creating container: $CLOUDFLARE_CONTAINER"
            az storage container create \
              --name "$CLOUDFLARE_CONTAINER" \
              --account-name "$STORAGE_ACCOUNT" \
              --auth-mode login
            echo "âœ… Container created: $CLOUDFLARE_CONTAINER"
          else
            echo "âœ… Container exists: $CLOUDFLARE_CONTAINER"
          fi

          # Create Cloudflare service-domain container
          CLOUDFLARE_SERVICE_CONTAINER="dculus-forms-cloudflare-services-${ENV}-state"
          if ! az storage container show \
            --name "$CLOUDFLARE_SERVICE_CONTAINER" \
            --account-name "$STORAGE_ACCOUNT" &>/dev/null; then
            echo "ðŸ“¦ Creating container: $CLOUDFLARE_SERVICE_CONTAINER"
            az storage container create \
              --name "$CLOUDFLARE_SERVICE_CONTAINER" \
              --account-name "$STORAGE_ACCOUNT" \
              --auth-mode login
            echo "âœ… Container created: $CLOUDFLARE_SERVICE_CONTAINER"
          else
            echo "âœ… Container exists: $CLOUDFLARE_SERVICE_CONTAINER"
          fi

          # Create Azure Container Apps container
          AZURE_CONTAINER="dculus-forms-azure-backend-${ENV}-state"
          if ! az storage container show \
            --name "$AZURE_CONTAINER" \
            --account-name "$STORAGE_ACCOUNT" &>/dev/null; then
            echo "ðŸ“¦ Creating container: $AZURE_CONTAINER"
            az storage container create \
              --name "$AZURE_CONTAINER" \
              --account-name "$STORAGE_ACCOUNT" \
              --auth-mode login
            echo "âœ… Container created: $AZURE_CONTAINER"
          else
            echo "âœ… Container exists: $AZURE_CONTAINER"
          fi

          # Create Cloudflare Pages container
          CLOUDFLARE_PAGES_CONTAINER="dculus-forms-cloudflare-pages-${ENV}-state"
          if ! az storage container show \
            --name "$CLOUDFLARE_PAGES_CONTAINER" \
            --account-name "$STORAGE_ACCOUNT" &>/dev/null; then
            echo "ðŸ“¦ Creating container: $CLOUDFLARE_PAGES_CONTAINER"
            az storage container create \
              --name "$CLOUDFLARE_PAGES_CONTAINER" \
              --account-name "$STORAGE_ACCOUNT" \
              --auth-mode login
            echo "âœ… Container created: $CLOUDFLARE_PAGES_CONTAINER"
          else
            echo "âœ… Container exists: $CLOUDFLARE_PAGES_CONTAINER"
          fi

          # Create Cloudflare Pages Admin container
          CLOUDFLARE_PAGES_ADMIN_CONTAINER="dculus-forms-cloudflare-pages-admin-${ENV}-state"
          if ! az storage container show \
            --name "$CLOUDFLARE_PAGES_ADMIN_CONTAINER" \
            --account-name "$STORAGE_ACCOUNT" &>/dev/null; then
            echo "ðŸ“¦ Creating container: $CLOUDFLARE_PAGES_ADMIN_CONTAINER"
            az storage container create \
              --name "$CLOUDFLARE_PAGES_ADMIN_CONTAINER" \
              --account-name "$STORAGE_ACCOUNT" \
              --auth-mode login
            echo "âœ… Container created: $CLOUDFLARE_PAGES_ADMIN_CONTAINER"
          else
            echo "âœ… Container exists: $CLOUDFLARE_PAGES_ADMIN_CONTAINER"
          fi

          # Create Cloudflare Pages Viewer container
          CLOUDFLARE_PAGES_VIEWER_CONTAINER="dculus-forms-cloudflare-pages-viewer-${ENV}-state"
          if ! az storage container show \
            --name "$CLOUDFLARE_PAGES_VIEWER_CONTAINER" \
            --account-name "$STORAGE_ACCOUNT" &>/dev/null; then
            echo "ðŸ“¦ Creating container: $CLOUDFLARE_PAGES_VIEWER_CONTAINER"
            az storage container create \
              --name "$CLOUDFLARE_PAGES_VIEWER_CONTAINER" \
              --account-name "$STORAGE_ACCOUNT" \
              --auth-mode login
            echo "âœ… Container created: $CLOUDFLARE_PAGES_VIEWER_CONTAINER"
          else
            echo "âœ… Container exists: $CLOUDFLARE_PAGES_VIEWER_CONTAINER"
          fi

          # Create Azure PostgreSQL container
          POSTGRES_CONTAINER="dculus-forms-postgres-${ENV}-state"
          if ! az storage container show \
            --name "$POSTGRES_CONTAINER" \
            --account-name "$STORAGE_ACCOUNT" &>/dev/null; then
            echo "ðŸ“¦ Creating container: $POSTGRES_CONTAINER"
            az storage container create \
              --name "$POSTGRES_CONTAINER" \
              --account-name "$STORAGE_ACCOUNT" \
              --auth-mode login
            echo "âœ… Container created: $POSTGRES_CONTAINER"
          else
            echo "âœ… Container exists: $POSTGRES_CONTAINER"
          fi

          # Create NeonDB container
          NEON_CONTAINER="dculus-forms-neon-${ENV}-state"
          if ! az storage container show \
            --name "$NEON_CONTAINER" \
            --account-name "$STORAGE_ACCOUNT" &>/dev/null; then
            echo "ðŸ“¦ Creating container: $NEON_CONTAINER"
            az storage container create \
              --name "$NEON_CONTAINER" \
              --account-name "$STORAGE_ACCOUNT" \
              --auth-mode login
            echo "âœ… Container created: $NEON_CONTAINER"
          else
            echo "âœ… Container exists: $NEON_CONTAINER"
          fi

  # Cleanup Azure Custom Domain and Certificate before destroying infrastructure
  cleanup-azure-custom-domain:
    name: Cleanup Custom Domain & Certificate
    runs-on: ubuntu-latest
    needs: [validate-destroy-request, setup-azure-backend]
    if: github.event.inputs.destroy_azure == 'true'
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set environment variables
        run: |
          ENV="${{ github.event.inputs.environment }}"
          echo "RESOURCE_GROUP=dculus-forms-${ENV}-rg" >> $GITHUB_ENV
          echo "CONTAINER_APP_NAME=dculus-forms-${ENV}-backend" >> $GITHUB_ENV
          echo "CONTAINER_ENV_NAME=dculus-forms-${ENV}-env" >> $GITHUB_ENV
          echo "CUSTOM_DOMAIN=form-services-${ENV}.dculus.com" >> $GITHUB_ENV
          echo "ENVIRONMENT=${ENV}" >> $GITHUB_ENV

      - name: Run cleanup script
        env:
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          chmod +x .github/scripts/cleanup-azure-custom-domain.sh
          ./.github/scripts/cleanup-azure-custom-domain.sh || {
            echo "âš ï¸ Cleanup failed but continuing with destruction"
            exit 0
          }

      - name: Display cleanup summary
        if: always()
        run: |
          echo "==================== Cleanup Summary ===================="
          echo "Custom Domain: form-services-${{ github.event.inputs.environment }}.dculus.com"
          echo "âœ… Custom domain cleanup completed"
          echo "Infrastructure destruction will proceed..."
          echo "================================================================"

  # Destroy Azure Container Apps (Stateless - Safe)
  terraform-azure-destroy:
    name: Destroy Azure Container Apps
    runs-on: ubuntu-latest
    needs: [validate-destroy-request, cleanup-azure-custom-domain]
    if: |
      always() && !cancelled() &&
      (needs.cleanup-azure-custom-domain.result == 'success' || needs.cleanup-azure-custom-domain.result == 'skipped') &&
      github.event.inputs.destroy_azure == 'true'
    environment: ${{ github.event.inputs.environment }}
    defaults:
      run:
        working-directory: ${{ env.AZURE_TERRAFORM_DIR }}/environments/${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: dculus-forms

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Azure Storage Account Key
        run: |
          ACCOUNT_KEY=$(az storage account keys list \
            --resource-group dculus-global-terraform-assets-resource-grp \
            --account-name dculusterraformstates \
            --query '[0].value' -o tsv)
          echo "::add-mask::$ACCOUNT_KEY"
          echo "ARM_ACCESS_KEY=$ACCOUNT_KEY" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Copy shared Terraform files
        run: |
          cp ../../main.tf .
          cp ../../variables.tf .
          cp ../../outputs.tf .
          echo "âœ… Copied shared Terraform files"

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=dculus-global-terraform-assets-resource-grp" \
            -backend-config="storage_account_name=dculusterraformstates" \
            -backend-config="container_name=dculus-forms-azure-backend-${{ github.event.inputs.environment }}-state" \
            -backend-config="key=terraform.tfstate"

      - name: Force Delete Container App (Bypass Hanging Resources)
        continue-on-error: true
        run: |
          ENV="${{ github.event.inputs.environment }}"
          RESOURCE_GROUP="dculus-forms-${ENV}-rg"
          CONTAINER_APP="dculus-forms-${ENV}-backend"
          
          echo "ðŸ”¥ Attempting to force-delete Container App to prevent hanging..."
          
          # Check if Container App exists
          if az containerapp show \
            --name "$CONTAINER_APP" \
            --resource-group "$RESOURCE_GROUP" &>/dev/null; then
            
            echo "ðŸ“Œ Container App found: $CONTAINER_APP"
            
            # Force delete without waiting for completion
            echo "ðŸ—‘ï¸ Initiating force delete (no-wait)..."
            az containerapp delete \
              --name "$CONTAINER_APP" \
              --resource-group "$RESOURCE_GROUP" \
              --yes \
              --no-wait || echo "âš ï¸ Force delete command failed, continuing..."
            
            echo "âœ… Delete initiated, will continue with Terraform destroy"
          else
            echo "â„¹ï¸ Container App not found, skipping force delete"
          fi

      - name: Terraform Destroy
        timeout-minutes: 30
        env:
          TF_VAR_better_auth_secret: ${{ secrets.BETTER_AUTH_SECRET }}
          TF_VAR_public_s3_access_key: ${{ secrets.PUBLIC_S3_ACCESS_KEY || 'placeholder' }}
          TF_VAR_public_s3_secret_key: ${{ secrets.PUBLIC_S3_SECRET_KEY || 'placeholder' }}
          TF_VAR_public_s3_endpoint: ${{ secrets.PUBLIC_S3_ENDPOINT || 'placeholder' }}
          TF_VAR_public_s3_cdn_url: ${{ secrets.PUBLIC_S3_CDN_URL || 'placeholder' }}
          TF_VAR_private_s3_bucket_name: ${{ secrets.PRIVATE_S3_BUCKET_NAME || 'placeholder' }}
          TF_VAR_public_s3_bucket_name: ${{ secrets.PUBLIC_S3_BUCKET_NAME || 'placeholder' }}
          TF_VAR_cors_origins: ${{ secrets.CORS_ORIGINS || 'placeholder' }}
          TF_VAR_container_image_tag: "placeholder"
          TF_VAR_admin_email: ${{ secrets.ADMIN_EMAIL || 'placeholder' }}
          TF_VAR_admin_password: ${{ secrets.ADMIN_PASSWORD || 'placeholder' }}
          TF_VAR_admin_name: ${{ secrets.ADMIN_NAME || 'placeholder' }}
          TF_VAR_email_host: ${{ secrets.EMAIL_HOST || 'placeholder' }}
          TF_VAR_email_port: ${{ secrets.EMAIL_PORT || '587' }}
          TF_VAR_email_user: ${{ secrets.EMAIL_USER || 'placeholder' }}
          TF_VAR_email_password: ${{ secrets.EMAIL_PASSWORD || 'placeholder' }}
          TF_VAR_email_from: ${{ secrets.EMAIL_FROM || 'placeholder' }}
          TF_VAR_chargebee_site: ${{ secrets.CHARGEBEE_SITE || 'placeholder' }}
          TF_VAR_chargebee_api_key: ${{ secrets.CHARGEBEE_API_KEY || 'placeholder' }}
        run: |
          echo "ðŸ”¥ Destroying Azure Container Apps with Terraform..."
          echo "â±ï¸ Timeout set to 30 minutes to prevent indefinite hanging"
          
          # Terraform will detect pre-deleted resources and update state accordingly
          # Using parallelism to speed up the destroy process
          terraform destroy \
            -auto-approve \
            -parallelism=10
          
          echo "âœ… Azure Container Apps destroyed successfully"
      
      - name: Cleanup Any Remaining Resources
        if: always()
        continue-on-error: true
        run: |
          ENV="${{ github.event.inputs.environment }}"
          RESOURCE_GROUP="dculus-forms-${ENV}-rg"
          
          echo "ðŸ§¹ Checking for any remaining resources in resource group..."
          
          # Check if resource group still exists
          if az group exists --name "$RESOURCE_GROUP" | grep -q "true"; then
            echo "ðŸ“Œ Resource group exists: $RESOURCE_GROUP"
            
            # List remaining resources
            echo "ðŸ“‹ Listing remaining resources:"
            az resource list --resource-group "$RESOURCE_GROUP" --output table || true
            
            # Force delete the entire resource group (last resort)
            echo "ðŸ—‘ï¸ Force deleting resource group to ensure cleanup..."
            az group delete \
              --name "$RESOURCE_GROUP" \
              --yes \
              --no-wait || echo "âš ï¸ Resource group deletion failed"
            
            echo "âœ… Cleanup commands executed"
          else
            echo "âœ… Resource group already deleted"
          fi

  # Destroy Cloudflare Pages Projects (form-app, admin-app, viewer-app)
  terraform-cloudflare-pages-destroy:
    name: Destroy Cloudflare Pages Projects
    runs-on: ubuntu-latest
    needs: [validate-destroy-request, terraform-azure-destroy]
    if: |
      always() && !cancelled() &&
      (needs.terraform-azure-destroy.result == 'success' || needs.terraform-azure-destroy.result == 'skipped') &&
      github.event.inputs.destroy_cloudflare_pages == 'true'
    environment: ${{ github.event.inputs.environment }}
    strategy:
      matrix:
        project:
          - name: form-app
            dir: cloudflare-pages
            description: Form Builder Application
          - name: admin-app
            dir: cloudflare-pages-admin
            description: Admin Dashboard
          - name: viewer-app
            dir: cloudflare-pages-viewer
            description: Form Viewer Application
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: dculus-forms

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Azure Storage Account Key
        run: |
          ACCOUNT_KEY=$(az storage account keys list \
            --resource-group dculus-global-terraform-assets-resource-grp \
            --account-name dculusterraformstates \
            --query '[0].value' -o tsv)
          echo "::add-mask::$ACCOUNT_KEY"
          echo "ARM_ACCESS_KEY=$ACCOUNT_KEY" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Copy shared Terraform files
        working-directory: dculus-forms/infrastructure/multi-cloud/terraform/${{ matrix.project.dir }}/environments/${{ github.event.inputs.environment }}
        run: |
          cp ../../main.tf .
          cp ../../variables.tf .
          cp ../../outputs.tf .
          cp ../../cloudflare-pages-domain.tf .
          echo "âœ… Copied shared Terraform files for ${{ matrix.project.name }}"

      - name: Terraform Init
        working-directory: dculus-forms/infrastructure/multi-cloud/terraform/${{ matrix.project.dir }}/environments/${{ github.event.inputs.environment }}
        run: |
          terraform init \
            -backend-config="resource_group_name=dculus-global-terraform-assets-resource-grp" \
            -backend-config="storage_account_name=dculusterraformstates" \
            -backend-config="container_name=dculus-forms-${{ matrix.project.dir }}-${{ github.event.inputs.environment }}-state" \
            -backend-config="key=terraform.tfstate"

      - name: Terraform Destroy
        working-directory: dculus-forms/infrastructure/multi-cloud/terraform/${{ matrix.project.dir }}/environments/${{ github.event.inputs.environment }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          TF_VAR_environment: ${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ”¥ Destroying Cloudflare Pages: ${{ matrix.project.description }}..."
          terraform destroy -auto-approve
          echo "âœ… Cloudflare Pages project destroyed: ${{ matrix.project.name }}"

  # Destroy Cloudflare Service Domain (Backend DNS)
  terraform-cloudflare-service-domain-destroy:
    name: Destroy Backend Service Domain
    runs-on: ubuntu-latest
    needs: [validate-destroy-request, terraform-cloudflare-pages-destroy]
    if: |
      always() && !cancelled() &&
      (needs.terraform-cloudflare-pages-destroy.result == 'success' || needs.terraform-cloudflare-pages-destroy.result == 'skipped') &&
      github.event.inputs.destroy_cloudflare_r2 == 'true'
    environment: ${{ github.event.inputs.environment }}
    defaults:
      run:
        working-directory: ${{ env.CLOUDFLARE_SERVICE_TERRAFORM_DIR }}/environments/${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: dculus-forms

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Azure Storage Account Key
        run: |
          ACCOUNT_KEY=$(az storage account keys list \
            --resource-group dculus-global-terraform-assets-resource-grp \
            --account-name dculusterraformstates \
            --query '[0].value' -o tsv)
          echo "::add-mask::$ACCOUNT_KEY"
          echo "ARM_ACCESS_KEY=$ACCOUNT_KEY" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Copy shared Terraform files
        run: |
          cp ../../main.tf .
          cp ../../variables.tf .
          cp ../../outputs.tf .
          echo "âœ… Copied shared Terraform files"

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=dculus-global-terraform-assets-resource-grp" \
            -backend-config="storage_account_name=dculusterraformstates" \
            -backend-config="container_name=dculus-forms-cloudflare-services-${{ github.event.inputs.environment }}-state" \
            -backend-config="key=terraform.tfstate"

      - name: Terraform Destroy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_environment: ${{ github.event.inputs.environment }}
          TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_backend_fqdn: "placeholder-not-needed-for-destroy"
        run: |
          echo "ðŸ”¥ Destroying backend service domain DNS (form-services-${{ github.event.inputs.environment }}.dculus.com)..."
          terraform destroy -auto-approve
          echo "âœ… Backend service domain destroyed successfully"

  # Destroy Cloudflare R2 Buckets (File Storage)
  terraform-cloudflare-destroy:
    name: Destroy Cloudflare R2 Buckets
    runs-on: ubuntu-latest
    needs: [validate-destroy-request, terraform-cloudflare-service-domain-destroy]
    if: |
      always() && !cancelled() &&
      (needs.terraform-cloudflare-service-domain-destroy.result == 'success' || needs.terraform-cloudflare-service-domain-destroy.result == 'skipped') &&
      github.event.inputs.destroy_cloudflare_r2 == 'true'
    environment: ${{ github.event.inputs.environment }}
    defaults:
      run:
        working-directory: ${{ env.CLOUDFLARE_TERRAFORM_DIR }}/environments/${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: dculus-forms

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Azure Storage Account Key
        run: |
          ACCOUNT_KEY=$(az storage account keys list \
            --resource-group dculus-global-terraform-assets-resource-grp \
            --account-name dculusterraformstates \
            --query '[0].value' -o tsv)
          echo "::add-mask::$ACCOUNT_KEY"
          echo "ARM_ACCESS_KEY=$ACCOUNT_KEY" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Copy shared Terraform files
        run: |
          cp ../../main.tf .
          cp ../../variables.tf .
          cp ../../r2-buckets.tf .
          cp ../../r2-custom-domains.tf .
          cp ../../r2-api-token.tf .
          cp ../../outputs.tf .
          echo "âœ… Copied shared Terraform files"

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=dculus-global-terraform-assets-resource-grp" \
            -backend-config="storage_account_name=dculusterraformstates" \
            -backend-config="container_name=dculus-forms-cloudflare-r2-${{ github.event.inputs.environment }}-state" \
            -backend-config="key=terraform.tfstate"

      - name: Warning - Files Will Be Deleted
        run: |
          echo "âš ï¸âš ï¸âš ï¸ WARNING âš ï¸âš ï¸âš ï¸"
          echo "All files in the following buckets will be PERMANENTLY DELETED:"
          echo "  - dculus-forms-private-${{ github.event.inputs.environment }}"
          echo "  - dculus-forms-public-${{ github.event.inputs.environment }}"
          echo ""
          echo "This includes:"
          echo "  - User uploads"
          echo "  - Form attachments"
          echo "  - Public assets"
          echo "  - All other files"
          echo ""
          echo "âš ï¸ NO BACKUPS - CANNOT BE RECOVERED âš ï¸"

      - name: Terraform Destroy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ðŸ”¥ Destroying Cloudflare R2 buckets and CDN configuration..."
          terraform destroy -auto-approve \
            -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -var="cloudflare_zone_id=${{ secrets.CLOUDFLARE_ZONE_ID }}"
          echo "âœ… Cloudflare R2 buckets and CDN destroyed successfully"

  # Destroy MongoDB Atlas Database
  terraform-mongodb-destroy:
    name: Destroy MongoDB Atlas Database
    runs-on: ubuntu-latest
    needs: [validate-destroy-request, terraform-cloudflare-destroy]
    if: |
      always() && !cancelled() &&
      (needs.terraform-cloudflare-destroy.result == 'success' || needs.terraform-cloudflare-destroy.result == 'skipped') &&
      github.event.inputs.destroy_mongodb == 'true'
    environment: ${{ github.event.inputs.environment }}
    defaults:
      run:
        working-directory: ${{ env.MONGODB_TERRAFORM_DIR }}/environments/${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: dculus-forms

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Azure Storage Account Key
        run: |
          ACCOUNT_KEY=$(az storage account keys list \
            --resource-group dculus-global-terraform-assets-resource-grp \
            --account-name dculusterraformstates \
            --query '[0].value' -o tsv)
          echo "::add-mask::$ACCOUNT_KEY"
          echo "ARM_ACCESS_KEY=$ACCOUNT_KEY" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Copy shared Terraform files
        run: |
          cp ../../main.tf .
          cp ../../variables.tf .
          cp ../../cluster.tf .
          cp ../../database-user.tf .
          cp ../../network-access.tf .
          cp ../../outputs.tf .
          echo "âœ… Copied shared Terraform files"

      - name: Terraform Init
        env:
          TF_VAR_mongodb_atlas_public_key: ${{ secrets.MONGODB_ATLAS_PUBLIC_KEY }}
          TF_VAR_mongodb_atlas_private_key: ${{ secrets.MONGODB_ATLAS_PRIVATE_KEY }}
          TF_VAR_mongodb_atlas_org_id: ${{ secrets.MONGODB_ATLAS_ORG_ID }}
          TF_VAR_database_password: ${{ secrets.MONGODB_DATABASE_PASSWORD }}
        run: |
          terraform init \
            -backend-config="resource_group_name=dculus-global-terraform-assets-resource-grp" \
            -backend-config="storage_account_name=dculusterraformstates" \
            -backend-config="container_name=dculus-forms-mongodb-${{ github.event.inputs.environment }}-state" \
            -backend-config="key=terraform.tfstate"

      - name: FINAL WARNING - MongoDB Destruction
        run: |
          echo "âš ï¸âš ï¸âš ï¸ FINAL WARNING âš ï¸âš ï¸âš ï¸"
          echo ""
          echo "You are about to PERMANENTLY DELETE the MongoDB Atlas cluster:"
          echo "  Project: dculus-forms-${{ github.event.inputs.environment }}"
          echo "  Cluster: dculus-forms-${{ github.event.inputs.environment }}-cluster"
          echo ""
          echo "This will DELETE ALL DATA including:"
          echo "  - All collections and documents"
          echo "  - All database records"
          echo "  - All configurations"
          echo ""
          echo "âš ï¸ NO BACKUPS AVAILABLE - DATA CANNOT BE RECOVERED âš ï¸"
          echo "âš ï¸ THIS IS PERMANENT AND IRREVERSIBLE âš ï¸"
          echo ""
          echo "Proceeding with destruction in 10 seconds..."
          sleep 10

      - name: Terraform Destroy
        env:
          TF_VAR_mongodb_atlas_public_key: ${{ secrets.MONGODB_ATLAS_PUBLIC_KEY }}
          TF_VAR_mongodb_atlas_private_key: ${{ secrets.MONGODB_ATLAS_PRIVATE_KEY }}
          TF_VAR_mongodb_atlas_org_id: ${{ secrets.MONGODB_ATLAS_ORG_ID }}
          TF_VAR_database_password: ${{ secrets.MONGODB_DATABASE_PASSWORD }}
        run: |
          echo "ðŸ”¥ Destroying MongoDB Atlas cluster..."
          terraform destroy -auto-approve
          echo "âœ… MongoDB Atlas cluster destroyed - ALL DATA PERMANENTLY DELETED"

  # Destroy Azure PostgreSQL Database
  terraform-postgres-destroy:
    name: Destroy Azure PostgreSQL Database
    runs-on: ubuntu-latest
    needs: [validate-destroy-request, terraform-mongodb-destroy]
    if: |
      always() && !cancelled() &&
      (needs.terraform-mongodb-destroy.result == 'success' || needs.terraform-mongodb-destroy.result == 'skipped') &&
      github.event.inputs.destroy_postgres == 'true'
    environment: ${{ github.event.inputs.environment }}
    defaults:
      run:
        working-directory: ${{ env.POSTGRES_TERRAFORM_DIR }}/environments/${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: dculus-forms

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Azure Storage Account Key
        run: |
          ACCOUNT_KEY=$(az storage account keys list \
            --resource-group dculus-global-terraform-assets-resource-grp \
            --account-name dculusterraformstates \
            --query '[0].value' -o tsv)
          echo "::add-mask::$ACCOUNT_KEY"
          echo "ARM_ACCESS_KEY=$ACCOUNT_KEY" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Copy shared Terraform files
        run: |
          cp ../../main.tf .
          cp ../../variables.tf .
          cp ../../outputs.tf .
          echo "âœ… Copied shared Terraform files"

      - name: Terraform Init
        env:
          TF_VAR_admin_password: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        run: |
          terraform init \
            -backend-config="resource_group_name=dculus-global-terraform-assets-resource-grp" \
            -backend-config="storage_account_name=dculusterraformstates" \
            -backend-config="container_name=dculus-forms-postgres-${{ github.event.inputs.environment }}-state" \
            -backend-config="key=terraform.tfstate"

      - name: FINAL WARNING - PostgreSQL Destruction
        run: |
          echo "âš ï¸âš ï¸âš ï¸ FINAL WARNING âš ï¸âš ï¸âš ï¸"
          echo ""
          echo "You are about to PERMANENTLY DELETE the Azure PostgreSQL database:"
          echo "  Server: dculus-forms-${{ github.event.inputs.environment }}-pg-server"
          echo "  Database: dculus-forms-${{ github.event.inputs.environment }}-backend-database"
          echo "  Resource Group: dculus-forms-${{ github.event.inputs.environment }}-postgres-rg"
          echo ""
          echo "This will DELETE ALL DATA including:"
          echo "  - All application data"
          echo "  - All database records"
          echo "  - All configurations"
          echo ""
          echo "âš ï¸ NO BACKUPS AVAILABLE - DATA CANNOT BE RECOVERED âš ï¸"
          echo "âš ï¸ THIS IS PERMANENT AND IRREVERSIBLE âš ï¸"
          echo ""
          echo "Proceeding with destruction in 10 seconds..."
          sleep 10

      - name: Terraform Destroy
        env:
          TF_VAR_admin_password: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        run: |
          echo "ðŸ”¥ Destroying Azure PostgreSQL database..."
          terraform destroy -auto-approve
          echo "âœ… Azure PostgreSQL database destroyed - ALL DATA PERMANENTLY DELETED"

  # Destroy NeonDB Database
  terraform-neon-destroy:
    name: Destroy NeonDB Database
    runs-on: ubuntu-latest
    needs: [validate-destroy-request, terraform-postgres-destroy]
    if: |
      always() && !cancelled() &&
      (needs.terraform-postgres-destroy.result == 'success' || needs.terraform-postgres-destroy.result == 'skipped') &&
      github.event.inputs.destroy_neon == 'true'
    environment: ${{ github.event.inputs.environment }}
    defaults:
      run:
        working-directory: dculus-forms/infrastructure/multi-cloud/terraform/neon-postgres/environments/${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: dculus-forms

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Azure Storage Account Key
        run: |
          ACCOUNT_KEY=$(az storage account keys list \
            --resource-group dculus-global-terraform-assets-resource-grp \
            --account-name dculusterraformstates \
            --query '[0].value' -o tsv)
          echo "::add-mask::$ACCOUNT_KEY"
          echo "ARM_ACCESS_KEY=$ACCOUNT_KEY" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Copy shared Terraform files
        run: |
          cp ../../main.tf .
          cp ../../variables.tf .
          cp ../../outputs.tf .
          cp ../../versions.tf .
          echo "âœ… Copied shared Terraform files"

      - name: Terraform Init
        env:
          TF_VAR_neon_api_key: ${{ secrets.NEON_API_KEY }}
        run: |
          terraform init \
            -backend-config="resource_group_name=dculus-global-terraform-assets-resource-grp" \
            -backend-config="storage_account_name=dculusterraformstates" \
            -backend-config="container_name=dculus-forms-neon-${{ github.event.inputs.environment }}-state" \
            -backend-config="key=terraform.tfstate"

      - name: Terraform Destroy
        env:
          TF_VAR_neon_api_key: ${{ secrets.NEON_API_KEY }}
        run: |
          echo "ðŸ”¥ Destroying NeonDB database..."
          terraform destroy -auto-approve
          echo "âœ… NeonDB database destroyed"

  # Generate destruction summary
  destroy-summary:
    name: Destruction Summary
    runs-on: ubuntu-latest
    needs: [
      validate-destroy-request,
      cleanup-azure-custom-domain,
      terraform-azure-destroy,
      terraform-cloudflare-pages-destroy,
      terraform-cloudflare-service-domain-destroy,
      terraform-cloudflare-destroy,
      terraform-mongodb-destroy,
      terraform-postgres-destroy,
      terraform-neon-destroy
    ]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ”¥ Multi-Cloud Infrastructure Destruction Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: \`${{ github.event.inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Confirmation**: âœ… \`${{ github.event.inputs.confirmation }}\` verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## âš ï¸ DESTRUCTION STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Destroy Requested | Status | Data Loss |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------------------|--------|-----------|" >> $GITHUB_STEP_SUMMARY

          # Azure Status
          if [ "${{ github.event.inputs.destroy_azure }}" = "true" ]; then
            AZURE_STATUS="${{ needs.terraform-azure-destroy.result == 'success' && 'âœ… Destroyed' || 'âŒ Failed' }}"
            echo "| Azure Container Apps | âœ… Yes | $AZURE_STATUS | â„¹ï¸ No data stored |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Azure Container Apps | âŒ No | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          fi

          # Cloudflare Pages Status
          if [ "${{ github.event.inputs.destroy_cloudflare_pages }}" = "true" ]; then
            PAGES_STATUS="${{ needs.terraform-cloudflare-pages-destroy.result == 'success' && 'âœ… Destroyed' || needs.terraform-cloudflare-pages-destroy.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }}"
            echo "| Cloudflare Pages (form-app, admin-app, viewer-app) | âœ… Yes | $PAGES_STATUS | â„¹ï¸ Static sites only |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Cloudflare Pages Projects | âŒ No | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          fi

          # Cloudflare R2 & CDN Status
          if [ "${{ github.event.inputs.destroy_cloudflare_r2 }}" = "true" ]; then
            SERVICE_DOMAIN_STATUS="${{ needs.terraform-cloudflare-service-domain-destroy.result == 'success' && 'âœ… Destroyed' || needs.terraform-cloudflare-service-domain-destroy.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }}"
            echo "| Backend Service Domain (DNS) | âœ… Yes | $SERVICE_DOMAIN_STATUS | â„¹ï¸ DNS records only |" >> $GITHUB_STEP_SUMMARY
            
            CF_STATUS="${{ needs.terraform-cloudflare-destroy.result == 'success' && 'âœ… Destroyed' || 'âŒ Failed' }}"
            echo "| Cloudflare R2 | âœ… Yes | $CF_STATUS | âš ï¸ ALL FILES LOST |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Backend Service Domain | âŒ No | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
            echo "| Cloudflare R2 | âŒ No | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          fi

          # MongoDB Status
          if [ "${{ github.event.inputs.destroy_mongodb }}" = "true" ]; then
            MONGODB_STATUS="${{ needs.terraform-mongodb-destroy.result == 'success' && 'âœ… Destroyed' || 'âŒ Failed' }}"
            echo "| MongoDB Atlas | âœ… Yes | $MONGODB_STATUS | âš ï¸âš ï¸ ALL DATA LOST |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| MongoDB Atlas | âŒ No | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          fi

          # Azure PostgreSQL Status
          if [ "${{ github.event.inputs.destroy_postgres }}" = "true" ]; then
            POSTGRES_STATUS="${{ needs.terraform-postgres-destroy.result == 'success' && 'âœ… Destroyed' || 'âŒ Failed' }}"
            echo "| Azure PostgreSQL | âœ… Yes | $POSTGRES_STATUS | âš ï¸âš ï¸ ALL DATA LOST |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Azure PostgreSQL | âŒ No | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          fi

          # NeonDB Status
          if [ "${{ github.event.inputs.destroy_neon }}" = "true" ]; then
            NEON_STATUS="${{ needs.terraform-neon-destroy.result == 'success' && 'âœ… Destroyed' || 'âŒ Failed' }}"
            echo "| NeonDB Postgres | âœ… Yes | $NEON_STATUS | âš ï¸âš ï¸ ALL DATA LOST |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| NeonDB Postgres | âŒ No | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Detailed destruction info
          if [ "${{ needs.terraform-azure-destroy.result }}" = "success" ]; then
            echo "## ðŸ”· Azure Container Apps Destroyed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Resource Group**: \`dculus-forms-${{ github.event.inputs.environment }}-rg\` - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "- **Container App**: \`dculus-forms-${{ github.event.inputs.environment }}-backend\` - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "- **Log Analytics**: All monitoring data - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.terraform-cloudflare-pages-destroy.result }}" = "success" ]; then
            echo "## ðŸ“„ Cloudflare Pages Projects Destroyed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **form-app**: Form Builder application - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "  - Project: \`form-app-${{ github.event.inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Custom domain removed from DNS" >> $GITHUB_STEP_SUMMARY
            echo "- **admin-app**: Admin Dashboard application - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "  - Project: \`form-admin-app-${{ github.event.inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Custom domain removed from DNS" >> $GITHUB_STEP_SUMMARY
            echo "- **viewer-app**: Form Viewer application - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "  - Project: \`viewer-app-${{ github.event.inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Custom domain removed from DNS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.terraform-cloudflare-service-domain-destroy.result }}" = "success" ]; then
            echo "## ðŸŒ Backend Service Domain Destroyed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Service Domain**: \`form-services-${{ github.event.inputs.environment }}.dculus.com\` - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "  - DNS CNAME record removed" >> $GITHUB_STEP_SUMMARY
            echo "  - Points to Azure Container Apps FQDN" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.terraform-cloudflare-destroy.result }}" = "success" ]; then
            echo "## â˜ï¸ Cloudflare R2 Buckets & CDN Destroyed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Private Bucket**: \`dculus-forms-private-${{ github.event.inputs.environment }}\` - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "  - All user uploads and attachments - PERMANENTLY LOST" >> $GITHUB_STEP_SUMMARY
            echo "- **Public Bucket**: \`dculus-forms-public-${{ github.event.inputs.environment }}\` - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "  - All public assets and images - PERMANENTLY LOST" >> $GITHUB_STEP_SUMMARY
            echo "- **CDN Domain**: \`public-cdn-${{ github.event.inputs.environment }}.dculus.com\` - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "  - DNS record removed" >> $GITHUB_STEP_SUMMARY
            echo "  - Custom domain disconnected" >> $GITHUB_STEP_SUMMARY
            echo "  - Page rule removed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.terraform-mongodb-destroy.result }}" = "success" ]; then
            echo "## ðŸƒ MongoDB Atlas Cluster Destroyed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Project**: \`dculus-forms-${{ github.event.inputs.environment }}\` - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "- **Cluster**: \`dculus-forms-${{ github.event.inputs.environment }}-cluster\` - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "- **Data**: All collections, documents, and configurations - PERMANENTLY LOST" >> $GITHUB_STEP_SUMMARY
            echo "- **Region**: Central India (CENTRAL_INDIA)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **WARNING**: MongoDB Atlas does NOT provide automatic backups for destroyed clusters." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.terraform-postgres-destroy.result }}" = "success" ]; then
            echo "## ðŸ˜ Azure PostgreSQL Database Destroyed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Server**: \`dculus-forms-${{ github.event.inputs.environment }}-pg-server\` - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "- **Database**: \`dculus-forms-${{ github.event.inputs.environment }}-backend-database\` - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "- **Resource Group**: \`dculus-forms-${{ github.event.inputs.environment }}-postgres-rg\` - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "- **Data**: All application data, records, configurations - PERMANENTLY LOST" >> $GITHUB_STEP_SUMMARY
            echo "- **SKU**: B_Standard_B1ms (Burstable, 1 vCore, 2 GiB RAM)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **WARNING**: 7-day backup retention has NO recovery after deletion." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.terraform-neon-destroy.result }}" = "success" ]; then
            echo "## ðŸŸ¢ NeonDB Database Destroyed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Project**: \`dculus-forms-${{ github.event.inputs.environment }}\` - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "- **Database**: \`dculus-forms-${{ github.event.inputs.environment }}\` - DELETED" >> $GITHUB_STEP_SUMMARY
            echo "- **Data**: All application data - PERMANENTLY LOST" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Recovery info
          echo "## â„¹ï¸ Important Notes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Terraform state preserved** - Infrastructure can be recreated" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **Data cannot be recovered** - No backups exist for destroyed resources" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ **To recreate infrastructure**: Run Multi-Cloud Deployment workflow" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Note**: Recreated infrastructure will start with empty databases" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“– **Documentation**: [Destruction Guide](https://github.com/${{ github.repository }}/tree/main/infrastructure/multi-cloud/terraform/DESTROY_GUIDE.md)" >> $GITHUB_STEP_SUMMARY
