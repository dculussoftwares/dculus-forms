name: Terraform - Cloudflare R2 Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
  pull_request:
    branches:
      - main
    paths:
      - 'infrastructure/multi-cloud/terraform/cloudflare/**'
      - '.github/workflows/terraform-cloudflare-r2.yml'

permissions:
  id-token: write      # Required for OIDC authentication with Azure
  contents: read       # Required for checking out code
  pull-requests: write # Required for commenting on PRs

env:
  TERRAFORM_VERSION: '1.6.0'
  WORKING_DIR: 'dculus-forms/infrastructure/multi-cloud/terraform/cloudflare'

jobs:
  # Determine which environment to deploy based on branch or manual input
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should_deploy: ${{ steps.set-env.outputs.should_deploy }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          # For manual workflow dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # For pull requests, only plan (no deploy)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Display environment info
        run: |
          echo "üåç Deploying to: ${{ steps.set-env.outputs.environment }}"
          echo "üöÄ Should deploy: ${{ steps.set-env.outputs.should_deploy }}"
          echo "üîÄ Event: ${{ github.event_name }}"
          echo "üìå Ref: ${{ github.ref }}"

  # Setup Azure backend infrastructure for Terraform state
  setup-azure-backend:
    name: Setup Azure Backend
    runs-on: ubuntu-latest
    needs: determine-environment
    if: needs.determine-environment.outputs.should_deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Azure Storage containers for Terraform state
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"
          RESOURCE_GROUP="dculus-global-terraform-assets-resource-grp"
          STORAGE_ACCOUNT="dculusterraformstates"
          CONTAINER_NAME="dculus-forms-cloudflare-r2-${ENV}-state"

          echo "üì¶ Setting up Terraform backend for environment: $ENV"

          # Check if storage account exists
          if ! az storage account show \
            --name "$STORAGE_ACCOUNT" \
            --resource-group "$RESOURCE_GROUP" &>/dev/null; then
            echo "‚ùå Storage account $STORAGE_ACCOUNT does not exist"
            echo "‚ÑπÔ∏è  It should have been created by the Azure deployment workflow"
            exit 1
          fi

          echo "‚úÖ Storage account exists: $STORAGE_ACCOUNT"

          # Create container if it doesn't exist
          if ! az storage container show \
            --name "$CONTAINER_NAME" \
            --account-name "$STORAGE_ACCOUNT" &>/dev/null; then
            echo "üì¶ Creating container: $CONTAINER_NAME"
            az storage container create \
              --name "$CONTAINER_NAME" \
              --account-name "$STORAGE_ACCOUNT" \
              --auth-mode login
            echo "‚úÖ Container created successfully"
          else
            echo "‚úÖ Container already exists: $CONTAINER_NAME"
          fi

  # Terraform Plan - Generate execution plan
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [determine-environment, setup-azure-backend]
    if: always() && !cancelled() && !failure()
    environment: ${{ needs.determine-environment.outputs.environment }}
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}/environments/${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: dculus-forms

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Copy shared Terraform files
        run: |
          # Copy root Terraform files to environment directory
          cp ../../main.tf .
          cp ../../variables.tf .
          cp ../../r2-buckets.tf .
          cp ../../outputs.tf .

          echo "‚úÖ Copied shared Terraform files"
          ls -la

      - name: Terraform Format Check
        run: terraform fmt -check -recursive || true

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=dculus-global-terraform-assets-resource-grp" \
            -backend-config="storage_account_name=dculusterraformstates" \
            -backend-config="container_name=dculus-forms-cloudflare-r2-${{ needs.determine-environment.outputs.environment }}-state" \
            -backend-config="key=${{ needs.determine-environment.outputs.environment }}/terraform.tfstate"

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -out=tfplan \
            -detailed-exitcode || echo "plan_exitcode=$?" >> $GITHUB_OUTPUT

      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tfplan-${{ needs.determine-environment.outputs.environment }}
          path: ${{ env.WORKING_DIR }}/environments/${{ needs.determine-environment.outputs.environment }}/tfplan
          retention-days: 5

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Plan üìù \`${{ needs.determine-environment.outputs.environment }}\`

            **Plan Status**: \`${{ steps.plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${{ steps.plan.outputs.stdout }}
            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # Terraform Apply - Execute the plan
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [determine-environment, terraform-plan]
    if: needs.determine-environment.outputs.should_deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}/environments/${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: dculus-forms

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Copy shared Terraform files
        run: |
          cp ../../main.tf .
          cp ../../variables.tf .
          cp ../../r2-buckets.tf .
          cp ../../outputs.tf .

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=dculus-global-terraform-assets-resource-grp" \
            -backend-config="storage_account_name=dculusterraformstates" \
            -backend-config="container_name=dculus-forms-cloudflare-r2-${{ needs.determine-environment.outputs.environment }}-state" \
            -backend-config="key=${{ needs.determine-environment.outputs.environment }}/terraform.tfstate"

      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ needs.determine-environment.outputs.environment }}
          path: ${{ env.WORKING_DIR }}/environments/${{ needs.determine-environment.outputs.environment }}

      - name: Terraform Apply
        id: apply
        run: |
          terraform apply -auto-approve tfplan

          # Capture outputs
          echo "private_bucket=$(terraform output -raw private_bucket_name)" >> $GITHUB_OUTPUT
          echo "public_bucket=$(terraform output -raw public_bucket_name)" >> $GITHUB_OUTPUT
          echo "r2_endpoint=$(terraform output -raw r2_endpoint_url)" >> $GITHUB_OUTPUT

      - name: Display Deployment Summary
        run: |
          echo "========================================"
          echo "‚úÖ R2 Buckets Deployed Successfully!"
          echo "========================================"
          echo ""
          echo "üåç Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ü™£ Private Bucket: ${{ steps.apply.outputs.private_bucket }}"
          echo "üåê Public Bucket: ${{ steps.apply.outputs.public_bucket }}"
          echo "üîó R2 Endpoint: ${{ steps.apply.outputs.r2_endpoint }}"
          echo ""
          echo "üìã Next Steps:"
          echo "1. Generate R2 API tokens in Cloudflare dashboard"
          echo "2. Update backend .env with R2 credentials"
          echo "3. Configure CORS if needed (see README)"
          echo "4. Setup custom domain for public bucket (optional)"
          echo ""
          echo "üìñ Documentation: infrastructure/multi-cloud/terraform/cloudflare/README.md"
          echo "========================================"

  # Summary job to report overall status
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [determine-environment, terraform-plan, terraform-apply]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# Cloudflare R2 Terraform Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: \`${{ needs.determine-environment.outputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch/Ref**: \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Plan | ${{ needs.terraform-plan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Apply | ${{ needs.terraform-apply.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.terraform-apply.result }}" = "success" ]; then
            echo "‚úÖ **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Generate R2 API tokens via Cloudflare dashboard" >> $GITHUB_STEP_SUMMARY
            echo "2. Update backend application environment variables" >> $GITHUB_STEP_SUMMARY
            echo "3. Configure CORS settings if needed" >> $GITHUB_STEP_SUMMARY
            echo "4. Setup custom domain for public bucket (optional)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.terraform-apply.result }}" = "skipped" ]; then
            echo "‚ÑπÔ∏è **Deployment was skipped** (plan-only mode or PR)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Deployment failed** - Check job logs for details" >> $GITHUB_STEP_SUMMARY
          fi
