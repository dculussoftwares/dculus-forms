name: Multi-Cloud Deployment (Cloudflare R2 + Azure Container Apps)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      deploy_cloudflare:
        description: 'Deploy Cloudflare R2 infrastructure'
        required: false
        type: boolean
        default: true
      deploy_azure:
        description: 'Deploy Azure Container Apps backend'
        required: false
        type: boolean
        default: true
  pull_request:
    branches:
      - main
    paths:
      - 'infrastructure/multi-cloud/terraform/**'
      - '.github/workflows/multi-cloud-deployment.yml'

permissions:
  id-token: write      # Required for OIDC authentication with Azure
  contents: read       # Required for checking out code
  pull-requests: write # Required for commenting on PRs

env:
  TERRAFORM_VERSION: '1.6.0'
  CLOUDFLARE_TERRAFORM_DIR: 'dculus-forms/infrastructure/multi-cloud/terraform/cloudflare'
  AZURE_TERRAFORM_DIR: 'dculus-forms/infrastructure/multi-cloud/terraform/azure'

jobs:
  # Determine which environment to deploy based on branch or manual input
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should_deploy: ${{ steps.set-env.outputs.should_deploy }}
      deploy_cloudflare: ${{ steps.set-env.outputs.deploy_cloudflare }}
      deploy_azure: ${{ steps.set-env.outputs.deploy_azure }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          # For manual workflow dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "deploy_cloudflare=${{ github.event.inputs.deploy_cloudflare }}" >> $GITHUB_OUTPUT
            echo "deploy_azure=${{ github.event.inputs.deploy_azure }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # For pull requests, only plan (no deploy)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "deploy_cloudflare=true" >> $GITHUB_OUTPUT
            echo "deploy_azure=true" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Display environment info
        run: |
          echo "ðŸŒ Deploying to: ${{ steps.set-env.outputs.environment }}"
          echo "ðŸš€ Should deploy: ${{ steps.set-env.outputs.should_deploy }}"
          echo "â˜ï¸ Deploy Cloudflare: ${{ steps.set-env.outputs.deploy_cloudflare }}"
          echo "ðŸ”· Deploy Azure: ${{ steps.set-env.outputs.deploy_azure }}"
          echo "ðŸ”€ Event: ${{ github.event_name }}"
          echo "ðŸ“Œ Ref: ${{ github.ref }}"

  # Setup Azure backend infrastructure for Terraform state
  setup-azure-backend:
    name: Setup Azure Backend
    runs-on: ubuntu-latest
    needs: determine-environment
    if: needs.determine-environment.outputs.should_deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Azure Storage containers for Terraform state
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"
          RESOURCE_GROUP="dculus-global-terraform-assets-resource-grp"
          STORAGE_ACCOUNT="dculusterraformstates"

          echo "ðŸ“¦ Setting up Terraform backend for environment: $ENV"

          # Check if storage account exists
          if ! az storage account show \
            --name "$STORAGE_ACCOUNT" \
            --resource-group "$RESOURCE_GROUP" &>/dev/null; then
            echo "âŒ Storage account $STORAGE_ACCOUNT does not exist"
            exit 1
          fi

          echo "âœ… Storage account exists: $STORAGE_ACCOUNT"

          # Create Cloudflare R2 container
          CLOUDFLARE_CONTAINER="dculus-forms-cloudflare-r2-${ENV}-state"
          if ! az storage container show \
            --name "$CLOUDFLARE_CONTAINER" \
            --account-name "$STORAGE_ACCOUNT" &>/dev/null; then
            echo "ðŸ“¦ Creating container: $CLOUDFLARE_CONTAINER"
            az storage container create \
              --name "$CLOUDFLARE_CONTAINER" \
              --account-name "$STORAGE_ACCOUNT" \
              --auth-mode login
            echo "âœ… Container created: $CLOUDFLARE_CONTAINER"
          else
            echo "âœ… Container exists: $CLOUDFLARE_CONTAINER"
          fi

          # Create Azure Container Apps container
          AZURE_CONTAINER="dculus-forms-azure-backend-${ENV}-state"
          if ! az storage container show \
            --name "$AZURE_CONTAINER" \
            --account-name "$STORAGE_ACCOUNT" &>/dev/null; then
            echo "ðŸ“¦ Creating container: $AZURE_CONTAINER"
            az storage container create \
              --name "$AZURE_CONTAINER" \
              --account-name "$STORAGE_ACCOUNT" \
              --auth-mode login
            echo "âœ… Container created: $AZURE_CONTAINER"
          else
            echo "âœ… Container exists: $AZURE_CONTAINER"
          fi

  # Build and push Docker image if needed
  check-docker-image:
    name: Check Docker Image
    runs-on: ubuntu-latest
    needs: [determine-environment]
    if: needs.determine-environment.outputs.deploy_azure == 'true'
    outputs:
      image_exists: ${{ steps.check-image.outputs.exists }}
      image_tag: ${{ steps.set-tag.outputs.tag }}
    steps:
      - name: Set image tag
        id: set-tag
        run: |
          # Use commit SHA as tag
          TAG="${{ github.sha }}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Using Docker image tag: ${TAG}"

      - name: Check if Docker image exists
        id: check-image
        run: |
          IMAGE_NAME="dculus/forms-backend"
          TAG="${{ steps.set-tag.outputs.tag }}"

          # Try to pull the image
          if docker manifest inspect "${IMAGE_NAME}:${TAG}" >/dev/null 2>&1; then
            echo "âœ… Docker image exists: ${IMAGE_NAME}:${TAG}"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Docker image does not exist: ${IMAGE_NAME}:${TAG}"
            echo "â„¹ï¸  Image will need to be built via the build.yml workflow"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

  # Terraform Plan for Cloudflare R2
  terraform-cloudflare-plan:
    name: Terraform Plan (Cloudflare R2)
    runs-on: ubuntu-latest
    needs: [determine-environment, setup-azure-backend]
    if: |
      always() && !cancelled() && !failure() &&
      needs.determine-environment.outputs.deploy_cloudflare == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    defaults:
      run:
        working-directory: ${{ env.CLOUDFLARE_TERRAFORM_DIR }}/environments/${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: dculus-forms

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Azure Storage Account Key
        id: get-storage-key
        run: |
          ACCOUNT_KEY=$(az storage account keys list \
            --resource-group dculus-global-terraform-assets-resource-grp \
            --account-name dculusterraformstates \
            --query '[0].value' -o tsv)
          echo "::add-mask::$ACCOUNT_KEY"
          echo "ARM_ACCESS_KEY=$ACCOUNT_KEY" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Copy shared Terraform files
        run: |
          cp ../../main.tf .
          cp ../../variables.tf .
          cp ../../r2-buckets.tf .
          cp ../../outputs.tf .
          echo "âœ… Copied shared Terraform files"

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=dculus-global-terraform-assets-resource-grp" \
            -backend-config="storage_account_name=dculusterraformstates" \
            -backend-config="container_name=dculus-forms-cloudflare-r2-${{ needs.determine-environment.outputs.environment }}-state" \
            -backend-config="key=terraform.tfstate"

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          terraform plan \
            -var="cloudflare_account_id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -out=tfplan

      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tfplan-cloudflare-${{ needs.determine-environment.outputs.environment }}
          path: ${{ env.CLOUDFLARE_TERRAFORM_DIR }}/environments/${{ needs.determine-environment.outputs.environment }}/tfplan
          retention-days: 5

  # Terraform Plan for Azure Container Apps
  terraform-azure-plan:
    name: Terraform Plan (Azure Container Apps)
    runs-on: ubuntu-latest
    needs: [determine-environment, setup-azure-backend, check-docker-image]
    if: |
      always() && !cancelled() && !failure() &&
      needs.determine-environment.outputs.deploy_azure == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    defaults:
      run:
        working-directory: ${{ env.AZURE_TERRAFORM_DIR }}/environments/${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: dculus-forms

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Azure Storage Account Key
        id: get-storage-key
        run: |
          ACCOUNT_KEY=$(az storage account keys list \
            --resource-group dculus-global-terraform-assets-resource-grp \
            --account-name dculusterraformstates \
            --query '[0].value' -o tsv)
          echo "::add-mask::$ACCOUNT_KEY"
          echo "ARM_ACCESS_KEY=$ACCOUNT_KEY" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Copy shared Terraform files
        run: |
          cp ../../main.tf .
          cp ../../variables.tf .
          cp ../../outputs.tf .
          echo "âœ… Copied shared Terraform files"

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        env:
          TF_VAR_mongodb_connection_string: ${{ secrets.MONGODB_CONNECTION_STRING }}
          TF_VAR_better_auth_secret: ${{ secrets.BETTER_AUTH_SECRET }}
          TF_VAR_s3_access_key: ${{ secrets.S3_ACCESS_KEY }}
          TF_VAR_s3_secret_key: ${{ secrets.S3_SECRET_KEY }}
          TF_VAR_s3_endpoint: ${{ secrets.S3_ENDPOINT }}
          TF_VAR_s3_private_bucket_name: ${{ secrets.S3_PRIVATE_BUCKET_NAME }}
          TF_VAR_s3_public_bucket_name: ${{ secrets.S3_PUBLIC_BUCKET_NAME }}
          TF_VAR_cors_origins: ${{ secrets.CORS_ORIGINS }}
          TF_VAR_container_image_tag: ${{ needs.check-docker-image.outputs.image_tag }}
        run: |
          terraform plan -out=tfplan

      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tfplan-azure-${{ needs.determine-environment.outputs.environment }}
          path: ${{ env.AZURE_TERRAFORM_DIR }}/environments/${{ needs.determine-environment.outputs.environment }}/tfplan
          retention-days: 5

  # Terraform Apply for Cloudflare R2
  terraform-cloudflare-apply:
    name: Terraform Apply (Cloudflare R2)
    runs-on: ubuntu-latest
    needs: [determine-environment, terraform-cloudflare-plan]
    if: needs.determine-environment.outputs.should_deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    outputs:
      private_bucket: ${{ steps.apply.outputs.private_bucket }}
      public_bucket: ${{ steps.apply.outputs.public_bucket }}
      r2_endpoint: ${{ steps.apply.outputs.r2_endpoint }}
    defaults:
      run:
        working-directory: ${{ env.CLOUDFLARE_TERRAFORM_DIR }}/environments/${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: dculus-forms

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Azure Storage Account Key
        run: |
          ACCOUNT_KEY=$(az storage account keys list \
            --resource-group dculus-global-terraform-assets-resource-grp \
            --account-name dculusterraformstates \
            --query '[0].value' -o tsv)
          echo "::add-mask::$ACCOUNT_KEY"
          echo "ARM_ACCESS_KEY=$ACCOUNT_KEY" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Copy shared Terraform files
        run: |
          cp ../../main.tf .
          cp ../../variables.tf .
          cp ../../r2-buckets.tf .
          cp ../../outputs.tf .

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=dculus-global-terraform-assets-resource-grp" \
            -backend-config="storage_account_name=dculusterraformstates" \
            -backend-config="container_name=dculus-forms-cloudflare-r2-${{ needs.determine-environment.outputs.environment }}-state" \
            -backend-config="key=terraform.tfstate"

      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-cloudflare-${{ needs.determine-environment.outputs.environment }}
          path: ${{ env.CLOUDFLARE_TERRAFORM_DIR }}/environments/${{ needs.determine-environment.outputs.environment }}

      - name: Terraform Apply
        id: apply
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          terraform apply -auto-approve tfplan

          # Capture outputs
          echo "private_bucket=$(terraform output -raw private_bucket_name)" >> $GITHUB_OUTPUT
          echo "public_bucket=$(terraform output -raw public_bucket_name)" >> $GITHUB_OUTPUT
          echo "r2_endpoint=$(terraform output -raw r2_endpoint_url)" >> $GITHUB_OUTPUT

  # Terraform Apply for Azure Container Apps
  terraform-azure-apply:
    name: Terraform Apply (Azure Container Apps)
    runs-on: ubuntu-latest
    needs: [determine-environment, terraform-azure-plan, check-docker-image]
    if: needs.determine-environment.outputs.should_deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    outputs:
      backend_url: ${{ steps.apply.outputs.backend_url }}
      graphql_endpoint: ${{ steps.apply.outputs.graphql_endpoint }}
      health_endpoint: ${{ steps.apply.outputs.health_endpoint }}
      container_app_name: ${{ steps.apply.outputs.container_app_name }}
    defaults:
      run:
        working-directory: ${{ env.AZURE_TERRAFORM_DIR }}/environments/${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: dculus-forms

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Azure Storage Account Key
        run: |
          ACCOUNT_KEY=$(az storage account keys list \
            --resource-group dculus-global-terraform-assets-resource-grp \
            --account-name dculusterraformstates \
            --query '[0].value' -o tsv)
          echo "::add-mask::$ACCOUNT_KEY"
          echo "ARM_ACCESS_KEY=$ACCOUNT_KEY" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Copy shared Terraform files
        run: |
          cp ../../main.tf .
          cp ../../variables.tf .
          cp ../../outputs.tf .

      - name: Terraform Init
        run: terraform init

      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-azure-${{ needs.determine-environment.outputs.environment }}
          path: ${{ env.AZURE_TERRAFORM_DIR }}/environments/${{ needs.determine-environment.outputs.environment }}

      - name: Terraform Apply
        id: apply
        env:
          TF_VAR_mongodb_connection_string: ${{ secrets.MONGODB_CONNECTION_STRING }}
          TF_VAR_better_auth_secret: ${{ secrets.BETTER_AUTH_SECRET }}
          TF_VAR_s3_access_key: ${{ secrets.S3_ACCESS_KEY }}
          TF_VAR_s3_secret_key: ${{ secrets.S3_SECRET_KEY }}
          TF_VAR_s3_endpoint: ${{ secrets.S3_ENDPOINT }}
          TF_VAR_s3_private_bucket_name: ${{ secrets.S3_PRIVATE_BUCKET_NAME }}
          TF_VAR_s3_public_bucket_name: ${{ secrets.S3_PUBLIC_BUCKET_NAME }}
          TF_VAR_cors_origins: ${{ secrets.CORS_ORIGINS }}
          TF_VAR_container_image_tag: ${{ needs.check-docker-image.outputs.image_tag }}
        run: |
          terraform apply -auto-approve tfplan

          # Capture outputs
          echo "backend_url=$(terraform output -raw backend_url)" >> $GITHUB_OUTPUT
          echo "graphql_endpoint=$(terraform output -raw backend_url)/graphql" >> $GITHUB_OUTPUT
          echo "health_endpoint=$(terraform output -raw backend_url)/health" >> $GITHUB_OUTPUT
          echo "container_app_name=$(terraform output -json deployment_info | jq -r '.container_app_name')" >> $GITHUB_OUTPUT

  # Health checks after deployment
  health-checks:
    name: Health Checks
    runs-on: ubuntu-latest
    needs: [determine-environment, terraform-azure-apply]
    if: |
      always() && !cancelled() &&
      needs.terraform-azure-apply.result == 'success'
    steps:
      - name: Wait for backend to be ready
        run: |
          echo "â³ Waiting 30 seconds for backend to stabilize..."
          sleep 30

      - name: Check backend health endpoint
        run: |
          HEALTH_URL="${{ needs.terraform-azure-apply.outputs.health_endpoint }}"
          echo "ðŸ¥ Checking health endpoint: $HEALTH_URL"

          MAX_RETRIES=5
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -sf "$HEALTH_URL" -o /dev/null; then
              echo "âœ… Health check passed!"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "âš ï¸ Health check failed (attempt $RETRY_COUNT/$MAX_RETRIES)"
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "â³ Waiting 15 seconds before retry..."
                sleep 15
              fi
            fi
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Check GraphQL endpoint
        run: |
          GRAPHQL_URL="${{ needs.terraform-azure-apply.outputs.graphql_endpoint }}"
          echo "ðŸ” Checking GraphQL endpoint: $GRAPHQL_URL"

          RESPONSE=$(curl -sf -X POST "$GRAPHQL_URL" \
            -H "Content-Type: application/json" \
            -d '{"query":"{ __typename }"}')

          if echo "$RESPONSE" | grep -q "__typename"; then
            echo "âœ… GraphQL endpoint is responding correctly!"
          else
            echo "âš ï¸ GraphQL endpoint returned unexpected response"
            echo "$RESPONSE"
          fi

  # Summary job to report overall status
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [
      determine-environment,
      terraform-cloudflare-plan,
      terraform-azure-plan,
      terraform-cloudflare-apply,
      terraform-azure-apply,
      health-checks
    ]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸš€ Multi-Cloud Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: \`${{ needs.determine-environment.outputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch/Ref**: \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ“Š Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Plan | Apply | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflare R2 | ${{ needs.terraform-cloudflare-plan.result }} | ${{ needs.terraform-cloudflare-apply.result }} | ${{ needs.terraform-cloudflare-apply.result == 'success' && 'âœ…' || needs.terraform-cloudflare-apply.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Azure Container Apps | ${{ needs.terraform-azure-plan.result }} | ${{ needs.terraform-azure-apply.result }} | ${{ needs.terraform-azure-apply.result == 'success' && 'âœ…' || needs.terraform-azure-apply.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Checks | - | - | ${{ needs.health-checks.result == 'success' && 'âœ…' || needs.health-checks.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Cloudflare R2 Summary
          if [ "${{ needs.terraform-cloudflare-apply.result }}" = "success" ]; then
            echo "## â˜ï¸ Cloudflare R2 Deployment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Private Bucket**: \`${{ needs.terraform-cloudflare-apply.outputs.private_bucket }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Public Bucket**: \`${{ needs.terraform-cloudflare-apply.outputs.public_bucket }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **R2 Endpoint**: \`${{ needs.terraform-cloudflare-apply.outputs.r2_endpoint }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Azure Container Apps Summary
          if [ "${{ needs.terraform-azure-apply.result }}" = "success" ]; then
            echo "## ðŸ”· Azure Container Apps Deployment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Backend URL**: [${{ needs.terraform-azure-apply.outputs.backend_url }}](${{ needs.terraform-azure-apply.outputs.backend_url }})" >> $GITHUB_STEP_SUMMARY
            echo "- **GraphQL Endpoint**: [${{ needs.terraform-azure-apply.outputs.graphql_endpoint }}](${{ needs.terraform-azure-apply.outputs.graphql_endpoint }})" >> $GITHUB_STEP_SUMMARY
            echo "- **Health Check**: [${{ needs.terraform-azure-apply.outputs.health_endpoint }}](${{ needs.terraform-azure-apply.outputs.health_endpoint }})" >> $GITHUB_STEP_SUMMARY
            echo "- **Container App**: \`${{ needs.terraform-azure-apply.outputs.container_app_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Overall Status
          if [ "${{ needs.terraform-cloudflare-apply.result }}" = "success" ] && [ "${{ needs.terraform-azure-apply.result }}" = "success" ]; then
            echo "## âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All infrastructure has been deployed successfully to the **${{ needs.determine-environment.outputs.environment }}** environment." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.terraform-cloudflare-apply.result }}" = "skipped" ] && [ "${{ needs.terraform-azure-apply.result }}" = "skipped" ]; then
            echo "## â„¹ï¸ Deployment Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This was a plan-only run (likely from a pull request). No infrastructure changes were applied." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Deployment Issues Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some deployment jobs encountered errors. Please check the job logs above for details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“– **Documentation**: [Multi-Cloud Terraform README](https://github.com/${{ github.repository }}/tree/main/infrastructure/multi-cloud/terraform)" >> $GITHUB_STEP_SUMMARY
