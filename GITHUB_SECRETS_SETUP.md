# GitHub Secrets Setup Guide

This guide explains how to configure GitHub repository secrets for the Dculus Forms deployment pipelines.

## Overview

The GitHub Actions workflows require several secrets to deploy the application to Azure Container Apps and Cloudflare. These secrets are stored securely in GitHub and are not visible in logs or code.

## How to Add GitHub Secrets

1. Navigate to your GitHub repository
2. Click on **Settings** → **Secrets and variables** → **Actions**
3. Click **New repository secret**
4. Enter the secret name and value
5. Click **Add secret**

## Required Secrets

### Core Infrastructure Secrets

These secrets are required for basic infrastructure deployment:

| Secret Name | Description | Example Value |
|------------|-------------|---------------|
| `MONGODB_CONNECTION_STRING` | MongoDB Atlas connection string | `mongodb+srv://user:pass@cluster.mongodb.net/dculus_forms` |
| `BETTER_AUTH_SECRET` | Authentication secret (min 32 chars) | `your-secure-random-string-min-32-characters` |
| `CORS_ORIGINS` | Allowed frontend origins (comma-separated) | `https://app.dculus.com,https://admin.dculus.com` |
| `AZURE_CLIENT_ID` | Azure service principal client ID | `00000000-0000-0000-0000-000000000000` |
| `AZURE_TENANT_ID` | Azure tenant ID | `00000000-0000-0000-0000-000000000000` |
| `AZURE_SUBSCRIPTION_ID` | Azure subscription ID | `00000000-0000-0000-0000-000000000000` |
| `CLOUDFLARE_API_TOKEN` | Cloudflare API token | `your-cloudflare-api-token` |
| `CLOUDFLARE_ACCOUNT_ID` | Cloudflare account ID | `your-cloudflare-account-id` |
| `CLOUDFLARE_ZONE_ID` | Cloudflare zone ID | `your-cloudflare-zone-id` |

### Storage (Cloudflare R2) Secrets

These secrets are for file storage using Cloudflare R2:

| Secret Name | Description | Example Value |
|------------|-------------|---------------|
| `PUBLIC_S3_ACCESS_KEY` | R2 access key ID (auto-generated by Terraform) | `auto-generated-by-workflow` |
| `PUBLIC_S3_SECRET_KEY` | R2 secret access key (auto-generated by Terraform) | `auto-generated-by-workflow` |
| `PUBLIC_S3_ENDPOINT` | R2 endpoint URL | `https://your-account-id.r2.cloudflarestorage.com` |
| `PUBLIC_S3_CDN_URL` | Public CDN URL for R2 | `https://public-cdn-prod.dculus.com` |
| `PRIVATE_S3_BUCKET_NAME` | Private bucket name | `dculus-forms-private-prod` |
| `PUBLIC_S3_BUCKET_NAME` | Public bucket name | `dculus-forms-public-prod` |

**Note:** The R2 credentials (`PUBLIC_S3_ACCESS_KEY` and `PUBLIC_S3_SECRET_KEY`) are automatically generated by the Terraform workflow. You only need to set these manually if you're using pre-existing R2 buckets.

### Admin User Setup Secrets

These secrets configure the initial super admin account:

| Secret Name | Description | Example Value |
|------------|-------------|---------------|
| `ADMIN_EMAIL` | Super admin email address | `admin@dculus.com` |
| `ADMIN_PASSWORD` | Super admin password (strong password) | `your-secure-admin-password` |
| `ADMIN_NAME` | Super admin display name | `Super Admin` |

### Email Configuration Secrets (AWS SES)

These secrets enable email sending through AWS Simple Email Service:

| Secret Name | Description | Example Value |
|------------|-------------|---------------|
| `EMAIL_HOST` | SMTP email host | `email-smtp.ap-south-1.amazonaws.com` |
| `EMAIL_PORT` | SMTP port | `587` |
| `EMAIL_USER` | SMTP username (AWS SES access key) | `AKIAXXQEZJBZ2CWQ7AKS` |
| `EMAIL_PASSWORD` | SMTP password (AWS SES secret key) | `your-ses-smtp-password` |
| `EMAIL_FROM` | From email address | `noreply@dculus.com` |

**Getting AWS SES Credentials:**
1. Go to AWS Console → Simple Email Service
2. Click on **SMTP Settings**
3. Click **Create SMTP Credentials**
4. Download the SMTP username and password
5. Use the SMTP endpoint for your region as `EMAIL_HOST`

### Billing Integration Secrets (Chargebee)

These secrets enable Chargebee billing integration:

| Secret Name | Description | Example Value |
|------------|-------------|---------------|
| `CHARGEBEE_SITE` | Chargebee site name | `dculus-global` |
| `CHARGEBEE_API_KEY` | Chargebee API key | `your-chargebee-api-key` |

**Getting Chargebee Credentials:**
1. Log in to your Chargebee account
2. Go to **Settings** → **API Keys and Webhooks**
3. Create or copy your API key
4. Your site name is in the URL: `https://[site-name].chargebee.com`

### Frontend Build Secrets (Optional)

These secrets are used for frontend builds:

| Secret Name | Description | Example Value |
|------------|-------------|---------------|
| `VITE_CDN_ENDPOINT` | CDN endpoint for frontend assets | `https://cdn.dculus.com` |
| `VITE_PIXABAY_API_KEY` | Pixabay API key for image search | `your-pixabay-api-key` |
| `VITE_FORM_VIEWER_URL` | Base URL for the public form viewer | `https://viewer-app.dculus.com` |

### Docker Hub Secrets

These secrets are for pushing Docker images:

| Secret Name | Description | Example Value |
|------------|-------------|---------------|
| `DOCKER_USERNAME` | Docker Hub username | `your-docker-username` |
| `DOCKER_PASSWORD` | Docker Hub password or access token | `your-docker-password` |

### MongoDB Atlas Secrets (Multi-Cloud Deployment)

These secrets are for MongoDB Atlas infrastructure:

| Secret Name | Description | Example Value |
|------------|-------------|---------------|
| `MONGODB_ATLAS_PUBLIC_KEY` | MongoDB Atlas public API key | `your-public-key` |
| `MONGODB_ATLAS_PRIVATE_KEY` | MongoDB Atlas private API key | `your-private-key` |
| `MONGODB_ATLAS_ORG_ID` | MongoDB Atlas organization ID | `your-org-id` |
| `MONGODB_DATABASE_PASSWORD` | Database user password | `your-database-password` |

## Quick Setup Script

You can add all required secrets using the GitHub CLI (`gh`):

```bash
# Core Infrastructure
gh secret set MONGODB_CONNECTION_STRING --body "your-mongodb-connection-string"
gh secret set BETTER_AUTH_SECRET --body "your-secure-random-string-min-32-characters"
gh secret set CORS_ORIGINS --body "https://app.dculus.com,https://admin.dculus.com"

# Azure
gh secret set AZURE_CLIENT_ID --body "your-azure-client-id"
gh secret set AZURE_TENANT_ID --body "your-azure-tenant-id"
gh secret set AZURE_SUBSCRIPTION_ID --body "your-azure-subscription-id"

# Cloudflare
gh secret set CLOUDFLARE_API_TOKEN --body "your-cloudflare-api-token"
gh secret set CLOUDFLARE_ACCOUNT_ID --body "your-cloudflare-account-id"
gh secret set CLOUDFLARE_ZONE_ID --body "your-cloudflare-zone-id"

# Admin Setup
gh secret set ADMIN_EMAIL --body "admin@dculus.com"
gh secret set ADMIN_PASSWORD --body "your-secure-admin-password"
gh secret set ADMIN_NAME --body "Super Admin"

# Email (AWS SES)
gh secret set EMAIL_HOST --body "email-smtp.ap-south-1.amazonaws.com"
gh secret set EMAIL_PORT --body "587"
gh secret set EMAIL_USER --body "your-ses-username"
gh secret set EMAIL_PASSWORD --body "your-ses-password"
gh secret set EMAIL_FROM --body "noreply@dculus.com"

# Chargebee
gh secret set CHARGEBEE_SITE --body "dculus-global"
gh secret set CHARGEBEE_API_KEY --body "your-chargebee-api-key"

# Docker Hub
gh secret set DOCKER_USERNAME --body "your-docker-username"
gh secret set DOCKER_PASSWORD --body "your-docker-password"
```

## Environment-Specific Secrets

The workflows support multiple environments (dev, staging, production). You can configure environment-specific secrets by:

1. Go to **Settings** → **Environments**
2. Create environments: `dev`, `staging`, `production`
3. For each environment, add environment-specific secrets
4. Environment secrets override repository secrets when the workflow runs

### Example: Environment-Specific MongoDB

```bash
# Production MongoDB
gh secret set MONGODB_CONNECTION_STRING --env production --body "mongodb+srv://prod-user:pass@prod-cluster.mongodb.net/dculus_forms"

# Staging MongoDB
gh secret set MONGODB_CONNECTION_STRING --env staging --body "mongodb+srv://staging-user:pass@staging-cluster.mongodb.net/dculus_forms"
```

## Security Best Practices

1. **Never commit secrets to code** - Use `.env.example` files for templates only
2. **Use strong passwords** - Generate secure random strings for secrets
3. **Rotate secrets regularly** - Update secrets periodically for security
4. **Limit access** - Only grant secret access to necessary team members
5. **Monitor secret usage** - Review GitHub Actions logs for suspicious activity
6. **Use environment protection** - Enable required reviewers for production deployments

## Verifying Secret Configuration

After adding secrets, verify they're configured correctly:

1. Go to **Settings** → **Secrets and variables** → **Actions**
2. Check that all required secrets are listed
3. Run the **Build Pipeline** or **Multi-Cloud Deployment** workflow
4. Check the workflow logs to ensure no "secret not found" errors

## Troubleshooting

### Secret Not Found Error

If you see errors like `secret.SECRET_NAME is undefined`:

1. Verify the secret name matches exactly (case-sensitive)
2. Check that the secret is added to the repository (not environment-only)
3. Ensure you have admin access to the repository

### Terraform Variable Errors

If Terraform shows "variable not set" errors:

1. Check that the secret is referenced correctly in the workflow file
2. Ensure the Terraform variable name matches the workflow environment variable
3. Verify the secret value is not empty

### Authentication Failures

If Azure or Cloudflare authentication fails:

1. Verify API tokens and credentials are still valid
2. Check that service principals have necessary permissions
3. Ensure no extra whitespace in secret values

## Workflow Files Using These Secrets

- `.github/workflows/build.yml` - Main build and deployment pipeline
- `.github/workflows/multi-cloud-deployment.yml` - Multi-cloud infrastructure deployment
- `.github/workflows/multi-cloud-destroy.yml` - Infrastructure destruction

## Additional Resources

- [GitHub Actions Secrets Documentation](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
- [Azure Service Principal Setup](https://learn.microsoft.com/en-us/azure/developer/github/connect-from-azure)
- [Cloudflare API Tokens](https://developers.cloudflare.com/fundamentals/api/get-started/create-token/)
- [AWS SES SMTP Credentials](https://docs.aws.amazon.com/ses/latest/dg/smtp-credentials.html)
- [Chargebee API Keys](https://www.chargebee.com/docs/2.0/api_keys.html)

## Support

For issues with secret configuration or deployment, please:

1. Check the workflow logs for specific error messages
2. Review this documentation for correct secret names and formats
3. Contact the DevOps team or create an issue in the repository
